---
Title: Exercise 04: Monitor Process Activity
Objective: Use Sysinternals Process Monitor (Procmon) to capture and analyze the file system and registry activity generated by a simple application like Calculator, providing insight into its runtime behavior.
Estimated Time: 20-30 minutes
Tools Needed: Windows OS, Sysinternals Process Monitor, Calculator application.
Setup Instructions: 
1. Download the Sysinternals Suite from the Microsoft website and extract it to a convenient location (e.g., `C:\Sysinternals`).
2. Ensure you have administrative privileges to run Process Monitor effectively.
---

## Steps

1.  **Launch Process Monitor as Administrator:**
    *   Navigate to your Sysinternals Suite directory.
    *   Right-click `procmon.exe` and select "Run as administrator".
    *   Procmon will immediately start capturing events. Let it run for a few seconds.

2.  **Clear Initial Capture and Prepare for Monitoring:**
    *   Click the "Clear" button (eraser icon) in the toolbar to clear all events currently displayed.
    *   Click the "Capture" button (magnifying glass icon, or "File System Activity", "Registry Activity", "Process and Thread Activity" icons) to *stop* the capture. This puts Procmon in a ready state.

3.  **Configure Filters for Calculator Process:**
    *   Click the "Filter" button (funnel icon) in the toolbar, or go to `Filter > Filter...` (`Ctrl+L`).
    *   Add a filter rule:
        *   **Architecture:** `Process Name`
        *   **Relation:** `is`
        *   **Value:** `Calculator.exe` (or `calc.exe` for older Windows versions)
        *   **Action:** `Include`
    *   Click "Add" and then "OK".

4.  **Start Capture and Launch Calculator:**
    *   Click the "Capture" button in Procmon to *start* capturing events.
    *   Launch the Calculator application (Start Menu -> Calculator).
    *   Perform a few simple operations in Calculator (e.g., `1 + 1 =`, `5 * 5 =`).
    *   Close the Calculator application.

5.  **Stop Capture and Analyze Events:**
    *   Click the "Capture" button in Procmon to *stop* capturing events.
    *   Observe the displayed events. You should see file system and registry operations related specifically to `Calculator.exe`.
    *   **File System Activity:** Look for operations like `CreateFile`, `ReadFile`, `CloseFile` involving files in `C:\Windows\System32`, `C:\Program Files`, or user `AppData` directories.
    *   **Registry Activity:** Look for operations like `RegOpenKey`, `RegQueryValue`, `RegSetValue` involving Calculator's configuration or history in the registry.

6.  **Use Process Tree (Optional):**
    *   Go to `Tools > Process Tree`. You can see `Calculator.exe` and its parent process.

## Expected Output

```
(The Procmon window will display a filtered list of file system and registry events generated by the Calculator process. You will see activities like DLL loading, configuration file access, and registry key read/write operations.)

Example Procmon output (filtered for Calculator.exe):
Time of Day   Process Name   PID     Operation      Path                                      Result    Detail
...
1:23:45.6789  Calculator.exe 5432    CreateFile     C:\Windows\System32\shell32.dll           SUCCESS   Desired Access: Read, Disposition: Open
1:23:45.7890  Calculator.exe 5432    RegOpenKey     HKLM\SOFTWARE\Microsoft\Windows\Calc      SUCCESS   Desired Access: Read
1:23:45.8901  Calculator.exe 5432    RegQueryValue  HKCU\SOFTWARE\Microsoft\Calculator\...    SUCCESS   Length: 4
1:23:46.0012  Calculator.exe 5432    ReadFile       C:\Windows\System32\en-US\Calculator...   SUCCESS   Offset: 0, Length: 8192
...
```
![Expected output](images/exercise-04-output.png)

## Reflection Questions

1.  What types of file system operations does a simple application like Calculator typically perform during its startup and operation?
2.  Why does Calculator (or any application) interact with the registry? Provide an example based on your observations.
3.  How could an attacker use Process Monitor to understand the persistence mechanisms or data access patterns of malware?

## Next Steps

*   [Exercise 05: Remote Command](05-remote-command.md)
*   Further reading: [Microsoft Docs: Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)

## Hints / Troubleshooting

*   If you see too many events, ensure your filter for `Calculator.exe` was applied *before* starting the capture of the Calculator activity.
*   You can remove irrelevant event types by clicking the icons in the toolbar (e.g., the "Disk" icon for file system, "Registry" icon for registry) to hide them.
*   Procmon logs a vast amount of data. Focusing on `SUCCESS` results for specific operations (e.g., `RegOpenKey`, `CreateFile`) can be more informative.
